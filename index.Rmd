---
title: "Programa de Prevención y Control del Dengue de Yucatán"
output: 
  flexdashboard::flex_dashboard:
      theme: flatly
output_dir: docs
cover-image: images/cover.jpg
---



```{r setup}

# Load the dengue dataset 
x <- boldenr::read_dataset_bol(path = "C:/Users/HOME/OneDrive/datasets/DGE/arbo/",
                                dataset = "sinave")

# load the heatmap confirmados y hospitalizados function 
source('C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/heatmap_confirmados.R')

# Step 2. load the function ####
source("C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_denv_dash_yuc/functions/heatmap_hospitalizados.R")

# Step load the leaflet map of larvae control ####
source("C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/cl_interactive_map.R")

library(magrittr)

# define the dataset 
path_vect <- "C:/Users/HOME/Dropbox/cenaprece_datasets/2022/31_yucatan"
path_coord <- paste(path_vect, "DescargaOvitrampasMesFco.txt", sep = "/")
# Load the ovitrap dataset 

ovis <- boldenr::read_dataset_bol(path = path_vect,
                                 dataset = "vectores",
                                 inf = "Lecturas")

# load the blocks #####
load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")

# load the control larvario dataset
cl <- boldenr::read_dataset_bol(path = path_vect, 
                                dataset = "vectores",
                                inf = "Control") |>
    dplyr::mutate(cve_geo = paste(cve_ent, cve_mpo, 
                                  #cve_loc, # 423522
                                  sector, 
                                  Manzana, sep = ""))

# Step 2. load the blocks ine 2020 ####
library(sf)
blocks_ine <- rgeomex::blocks_ine20_mx_e |>
    dplyr::filter(entidad == "31")


# Step 3. load the AGEM inegi 2019 ####
mpo_inegi <- rgeomex::AGEM_inegi19_mx[, c("CVE_MUN", "geometry")] 

# Step 4. spatial joint for add the CVE_MUN to ine blocks 2020 ####
 blocks_ine <- sf::st_join(x = blocks_ine,
                           y = mpo_inegi) |>
    dplyr::mutate(cve_geo = paste(stringr::str_pad(entidad, pad = "0", width = 2, side = "left"),
                                  stringr::str_pad(CVE_MUN, pad = "0", width = 3, side = "left"),
                                  #stringr::str_pad(localidad, pad = "0", width = 4, side = "left"),
                                  stringr::str_pad(seccion, pad = "0", width = 4, side = "left"),
                                  stringr::str_pad(manzana, pad = "0", width = 4, side = "left"),
                                  sep = "")) 

# Step 5. left joint control larvario and blocks ine 2020 datasets ####
control_larvario_blocks <- dplyr::left_join(x = blocks_ine  |>
                                                dplyr::select(geometry, cve_geo, CVE_MUN),
                      y = cl,
                      by  = "cve_geo") |>
    dplyr::filter(!is.na(cve_ent))  |>
    dplyr::mutate(coverage = dplyr::case_when(Cobertura.en.Manzana < 51 ~ "Deficiente",
                                              Cobertura.en.Manzana >= 51 & Cobertura.en.Manzana < 70 ~ "Regular",
                                              Cobertura.en.Manzana >= 70 & Cobertura.en.Manzana < 85 ~ "Bueno",
                                              Cobertura.en.Manzana >= 85 ~ "Óptimo",
                                              T ~ "NA")) |>
    dplyr::mutate(coverage =  factor(coverage,
                                     levels = c("Bueno","Deficiente","Óptimo","Regular")[c(3, 1, 4, 2)],
                                     labels = c("Bueno","Deficiente","Óptimo","Regular")[c(3, 1, 4, 2)]))


# Load the ulv dataset ####
neb <- boldenr::read_dataset_bol(path = path_vect, 
                                 dataset = "vectores",
                                 inf = "Nebulizacion")

# load the larvae control ####
cl <- boldenr::read_dataset_bol(path = path_vect, 
                                dataset = "vectores",
                                inf = "Control")

#####################
# Step 1. load the hotspots dengue cases ####

load("C:/Users/HOME/Dropbox/hotspots_2021/8.RData/cases_hotspots_agebs19.RData")
#load("C:/Users/HOME/Dropbox/hotspots_2021/8.RData/hotspots_ageb_31_yucatan.RData")
cases_hotspots_agebs19 <- cases_hotspots_agebs19 |>
    sf::st_make_valid()

# Step 2. load the risk_ageb function ####
source('C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/risk_agebs.R')

# Step 3. load the risk_map function ####
source("C:/Users/HOME/OneDrive/proyects/hotspots/3.Functions/risk_map.R")

# Step 4. load the hotspots map ####
source("C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/hotspots_map.R")

# Step 5. create the function for extract the locality ####
extract_locality <- function(cve_edo, locality){
    rgeomex::loc_inegi19_mx |>
        dplyr::filter(CVE_ENT %in% c(cve_edo)) |>
        dplyr::filter(NOMGEO %in% c(rgeomex::find_most_similar_string(locality, unique(NOMGEO)))) |>
        sf::st_make_valid()
}

# Step 6. define the function for eggs intensity ##### 
intensity_function <- function(x){
    y <- x |>
        dplyr::mutate(hotspots_binary = ifelse(hotspots == "Hotspots", 1, 0)) |>
        as.data.frame() |>
        dplyr::select(x, y, week, hotspots_binary) |>
        tidyr::pivot_wider(id_cols = c(x, y),
                           names_from = "week",
                           #names_prefix = "hotspots",
                           values_from = "hotspots_binary") |>
        as.data.frame() 
    
    y$intensity <- rowSums(y |> dplyr::select(-1, -2))
    y$per_intensity <- round((y$intensity/ncol(y |> dplyr::select(-1, -2, -intensity)))*100,digits = 1)
    y |> dplyr::select(x, y, intensity,per_intensity)
}

# Step 7. load the dengue vector hotspots ####
load("C:/Users/HOME/OneDrive/proyects/hotspots_eggs/8.RData/31_yucatan/betas/31_yucatan_zinb1_betas.RData")

```

```{r libraris}
options(shiny.maxRequestSize=30*1024^2)
library(formattable)
library(tmap)
library(rmarkdown)
library(knitr)
library(shiny)
library(flexdashboard)
library(plotly)
library(boldenr)
library(magrittr)
library(leaflet)
library(ggplot2)
library(dplyr)
library(stringr)
library(dash)
library(ECharts2Shiny)
```



**Vigilancia Epidemiológica**
=====================================  

Column {.tabset}
------------------------------------


### **<span style="color:#7d9029"> Casos por Estado </span>**
<html>
<head>
<style>
</style>
</head>
<body>
<div >
  <h2></h2>
  <p></p>


<div style = "display: grid; width: 1px; grid-template-columns: 700px 700px; align-items: start; justify-content: space-between;">
#### **<span style="color:blue"> Treemap de casos confirmados </span>**
```{r treemap_national, out.width="100%", out.height="100%"}
x  |>
    dplyr::filter(ANO == 2022)  |>
    dplyr::filter(!DES_EDO_RES %in% c("OTROS PAISES", 
                                      "OTROS PAISES DE LATINOAMERICA",
                                      "ESTADOS UNIDOS DE NORTEAMERICA"))  |>
    dplyr::filter(DES_DIAG_FINAL %in% 
                      c("DENGUE CON SIGNOS DE ALARMA", "DENGUE NO GRAVE", 
                        "DENGUE GRAVE"))  |>
    dplyr::group_by(DES_EDO_RES,DES_DIAG_FINAL)  |>
    dplyr::summarise(value = dplyr::n(), 
                     .groups = "drop")  |>
    dplyr::mutate(DES_EDO_RES = stringr::str_to_title(DES_EDO_RES),
                  DES_DIAG_FINAL = stringr::str_to_title(DES_DIAG_FINAL))  |>
    dplyr::mutate(DES_DIAG_FINAL = factor(DES_DIAG_FINAL,
                                          levels = c("Dengue Con Signos De Alarma",
                                                     "Dengue Grave",
                                                     "Dengue No Grave"),
                                          labels = c("DSA", "DG", "DNG")))  |>
    ggplot2::ggplot(ggplot2::aes(area = value, 
                                 fill = DES_EDO_RES,
                                 subgroup = DES_EDO_RES,
                                 label = DES_DIAG_FINAL)) +
    treemapify::geom_treemap() +
    treemapify::geom_treemap_text(fontface = "italic", 
                                  colour = "black", 
                                  place = "bottom",
                                  #alpha = 0.5,
                                  grow = F) +
    treemapify::geom_treemap_subgroup_text(place = "middle", 
                                           colour = "White", 
                                           #alpha = 0.8, 
                                           grow = T)+
    ggplot2::theme(legend.position = "none") +
    ggplot2::scale_fill_viridis_d()
```

<div>
#### **<span style="color:blue"> Casos confirmados y serotipos </span>**
```{r casos_serotipos,out.width="100%", out.height="100%"}
boldenr::plot_state_serotype(dataset = x, 
                                  year = 2022, 
                                  x_serotype  = 0.5, 
                                  y_serotype = 0.17, 
                                  scale_serotype = 1.7)
```
</div>
</div>


#### **<span style="color:blue"> Casos confirmados por semana </span>**
```{r casos_semana}
heatmap_confirmados(dataset = x, 
                    year = 2022, 
                    size_text = 3, 
                    EDO = TRUE)
```

#### **<span style="color:blue"> Casos Confirmados </span>**
```{r bumpmap_national_2022, out.width="100%", out.height="100%"}
source('C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/static_bump_map.R')
library(dplyr)
static_bump_map(dataset = x,
                year = "2022",
                state = TRUE,
                size_text_value = 2,
                size_text = 1,
                country_text_x = 0.5,
                country_text_y = 0.8,
                line_size = 1.5,
                pal_vir = "viridis")
```

</div>
</body>
</html>



### **<span style="color:#7d9029"> Casos Confirmados por JS & Municipio </span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: darkgreen;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>

#### **<span style="color:#7d9029">Casos por Semana & Jurisdición </span>**
```{r}
heatmap_confirmados(dataset = x, 
                    year = 2022, 
                    size_text = 3,
                    state = "YUCATAN",
                    JS = TRUE,
                    MPO = TRUE,
                    EDO = FALSE)
```

#### **<span style="color:#7d9029">Casos por Semana & Municipio</span>**
```{r}
heatmap_confirmados(dataset = x, 
                    year = 2022, 
                    size_text = 3,
                    state = "YUCATAN",
                    JS = FALSE,
                    MPO = TRUE,
                    EDO = FALSE)
```
</div>
</body>
</html>


### **<span style="color:#7d9029"> Hospitalizados por JS & Municipio </span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: darkgreen;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>

#### **<span style="color:#7d9029">Casos Hospitalizados por Semana & Jurisdición </span>**
```{r}
heatmap_hospitalizados(dataset = x,
                       year = 2022,
                       size_text = 3,
                       state = "YUCATAN",
                       JS = TRUE)
```

#### **<span style="color:#7d9029">Casos Hospitalizados por Semana & Municipio</span>**
```{r}
heatmap_hospitalizados(dataset = x,
                       year = 2022,
                       size_text = 3,
                       state = "YUCATAN",
                       JS = FALSE)
```
</div>
</body>
</html>




### **<span style="color:#7d9029">Canal Endémico </span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: darkgreen;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>
#### **<span style="color:#7d9029">Canal Endémico Estatal </span>**
```{r}
load("C:/Users/HOME/OneDrive/automatic_read_sinave/8.RData/epid_channel_data_js.RData")
plotly::ggplotly(boldenr::epi_channel(x = boldenr::dendata_epichannel,
                                      edo = "YUCATAN", 
                                      jur = NULL,
                                      y = x,
                                      year1 = 2021,
                                      year2 = 2022,
                                      x_epi = 34, y_epi = 200,
                                      x_alerta = 40, y_alerta = 120, 
                                      x_seg = 40, y_seg = 40,
                                      x_exito = 37, y_exito = 5))



```

#### **<span style="color:#7d9029">Canal Endémico Jurisdicción Mérida </span>**
```{r}
load("C:/Users/HOME/OneDrive/automatic_read_sinave/8.RData/epid_channel_data_js.RData")
plotly::ggplotly(boldenr::epi_channel(x = y,
                                      edo = "YUCATAN", 
                                      jur = "MERIDA",
                                      mpo = NULL,
                                      y = x,
                                      year1 = 2021,
                                      year2 = 2022,
                                      x_epi = 20, y_epi = 90,
                                      x_alerta = 36, y_alerta = 50, 
                                      x_seg = 35, y_seg = 15,
                                      x_exito = 42, y_exito = 1))

```

#### **<span style="color:#7d9029">Canal Endémico Jurisdicción Valladolid </span>**
```{r}
load("C:/Users/HOME/OneDrive/automatic_read_sinave/8.RData/epid_channel_data_js.RData")

plotly::ggplotly(boldenr::epi_channel(x = y,
                                      edo = "YUCATAN", 
                                      jur = "VALLADOLID",
                                      mpo = NULL,
                                      y = x,
                                      year1 = 2021,
                                      year2 = 2022,
                                      x_epi = 35, y_epi = 25,
                                      x_alerta = 36, y_alerta = 16, 
                                      x_seg = 40, y_seg = 10,
                                      x_exito = 42, y_exito = 1))

```
</div>
</body>
</html>

### **<span style="color:#7d9029">Distribución de Casos </span>**

```{r}
# step 1. dengue cases geocoded ####
load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/den2022_positivos.RData")
y <- z[stringr::str_which(z$formatted_address,  " Mexico"),]


# step 2. load the yucatan boundary ####
x <- rgeomex::AGEE_inegi19_mx |>
    dplyr::filter(CVE_ENT %in% c("31"))


# Step 3. extract the dengue cases by state ####


# Step 3.1 convert the dataset in sf object 

y <- y |>
    dplyr::mutate(x = long,
                  y = lat) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 3.2 extract the dengue cases
y <- y[x, ]


# step 2. create the palette ####
pal <- leaflet::colorBin(palette = fishualize::fish(n = length(unique(y$SEM)), 
                                                    option = "Hypsypops_rubicundus",
                                                    end = 1,
                                                    alpha = .5),
                         domain = y$SEM,
                         bins = 10)

y1 <- y  |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 1)

y2 <- y  |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 2)
y3 <- y  |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 3)
y4 <- y  |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 4)
########################

# step 3. generate maps ####
l <- leaflet::leaflet(y)  |> 
    leaflet::addTiles()  |> 
    leaflet::addCircleMarkers(color = ~pal(SEM),
                              group = "DENV",
                              stroke = FALSE, 
                              opacity = 0.5,
                              fillOpacity = 0.5)  |>
    leaflet::addCircleMarkers(data = y1,
                              group = "Serotipo 1",
                              color = ~pal(SEM),
                              stroke = FALSE, 
                              opacity = 0.5,
                              fillOpacity = 0.5)  |>
    leaflet::addCircleMarkers(data = y2,
                              group = "Serotipo 2",
                              color = ~pal(SEM),
                              stroke = FALSE, 
                              opacity = 0.5,
                              fillOpacity = 0.5)  |>
    leaflet::addCircleMarkers(data = y3,
                              group = "Serotipo 3",
                              color = ~pal(SEM),
                              stroke = FALSE, 
                              opacity = 0.5,
                              fillOpacity = 0.5)  |>
    leaflet::addCircleMarkers(data = y4,
                              group = "Serotipo 4",
                              color = ~pal(SEM),
                              stroke = FALSE, 
                              opacity = 0.5,
                              fillOpacity = 0.5)  |>
    #leaflet::addPolylines(data = rgeomex::loc_inegi19_mx,
    #                     color = "darkblue",
    #                    label = ~NOMGEO,
    #                   group = "Localidad",
    #                  fillOpacity = .7,
    #                 opacity = .9,
    #                weight = .5)  |>
    #leaflet.extras::addSearchFeatures(targetGroups = "Localidad",
    #   options = leaflet.extras::searchFeaturesOptions(zoom #= 14, 
    #openPopup = FALSE))  |>
    
leaflet::addLegend("bottomright", 
                   group = "legend",
                   pal = pal, 
                   values = ~SEM,
                   title = "Semana Epidemiológica",
                   opacity = 0.9,
                   position = "bottomleft")

# Step 4. generate the tiles and provider ###
esri <- grep("^Esri|CartoDB|OpenStreetMap", 
             leaflet::providers, 
             value = TRUE)

for (provider in esri) {
    l <- l  |> leaflet::addProviderTiles(provider, 
                                         group = provider)
}

l  |>
    leaflet::addLayersControl(baseGroups = names(esri),
                              overlayGroups = c("legend", "DENV", "Serotipo 1",
                                                "Serotipo 2", "Serotipo 3",
                                                "Serotipo 4"),
                              options = leaflet::layersControlOptions(collapsed = TRUE))  |>
    leaflet::addMiniMap(tiles = esri[[1]], 
                        toggleDisplay = TRUE,
                        position = "bottomleft")  |>
    htmlwidgets::onRender("
    function(el, x) {
      var myMap = this;
      myMap.on('baselayerchange',
        function (e) {
          myMap.minimap.changeLayer(L.tileLayer.provider(e.name));
        })
    }")

```



**Vigilancia Entomológica**
=====================================  

Column {.tabset}
------------------------------------

### **<span style="color:#660033"> Ovitrampas </span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: darkgreen;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>
#### **<span style="color:#7d9029">Áreas urbanas con Vigilancia Entomológica </span>**
```{r echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center",out.width="90%", cache = TRUE, fig.show = "hold"}
# 1.load the AGEM of veracruz #####
library(magrittr)
library(sf)
mun <- rgeomex::AGEM_inegi19_mx  |>
    dplyr::filter(CVE_ENT == "31")

# Step 2. load the urban localities ####
urb_loc <- rgeomex::loc_inegi19_mx  |>
    dplyr::filter(CVE_ENT == "31")

# Step 3. extract the high risk localities ####
# Step 3.1 load the cenaprece metas ####
x <- readxl::read_xls(path = "Datasets/repMetas.xls",
                      sheet = 1, skip = 11)  |>
    dplyr::select(1:2, 7:10, 14, 16)  |>
    dplyr::mutate(cve_mun = stringr::str_sub(MUNICIPIO, start = 1, end = 3),
                  cve_loc = stringr::str_sub(LOCALIDAD, start = 1, end = 4))
# Step 3.2 extract high risk localities 
urb_loc_hr <- urb_loc  |>
    dplyr::filter(CVE_MUN %in% c(x$cve_mun))  |>
    dplyr::filter(CVE_LOC %in% c(x$cve_loc))

# Step 4. extract the localities with ovitraps ####
y <- readxl::read_xls(path = "Datasets/repMetas.xls",
                      sheet = 1, skip = 11)  |>
    dplyr::select(1:2, 7:10, 14, 16)  |>
    dplyr::mutate(cve_mun = stringr::str_sub(MUNICIPIO, start = 1, end = 3),
                  cve_loc = stringr::str_sub(LOCALIDAD, start = 1, end = 4))  |>
    dplyr::filter(`CON OVITRAMPAS` == "Sí")
urb_loc_hr_ovi <- urb_loc  |>
    dplyr::filter(CVE_MUN %in% c(y$cve_mun))  |>
    dplyr::filter(CVE_LOC %in% c(y$cve_loc, "0037"))

# Step 5. visualization ####
ggplot2::ggplot() +
    ggplot2::geom_sf(data = mun, fill = "gray90", col = "gray90") + 
    #ggplot2::geom_sf(data = urb_loc, fill = "gray40") +
    ggplot2::geom_sf(data = urb_loc_hr, fill = "gray") + 
    ggplot2::geom_sf(data = urb_loc_hr_ovi, fill = "red") +
    ggplot2::theme_void() +
    ggspatial::annotation_north_arrow(location = "tr") +
    ggspatial::annotation_scale() +
    ggplot2::coord_sf(xlim = c(-90.5, -87.05), 
                    ylim = c(19.5, 22), 
                     expand = FALSE)

```


#### **<span style="color:#7d9029">Indicador de Ovitrampas en Mérida</span>**
```{r indicador_ovitrampas_merida, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}


##  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Mérida",
                            all = FALSE)

```


#### **<span style="color:#7d9029"> Manzanas Calientes del área urbana de Mérida en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_merida, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

# Step 1. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")


# Step 1.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)


# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Mérida",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "50",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```


#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Mérida en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_merida, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Merida",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 30,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-1,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map
```


#### **<span style="color:#7d9029">Indicador de Ovitrampas en Valladolid</span>**
```{r indicador_ovitrampas_valladolid, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Valladolid",
                            all = FALSE)

```


#### **<span style="color:#7d9029"> Manzanas Calientes de Valladolid en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_valladolid, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}


# Step 2. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")


# Step 2.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)

# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Valladolid",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "102",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```


#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Valladolid en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_valladolid, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Valladolid",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 80,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-1,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```


#### **<span style="color:#7d9029">Indicador de Ovitrampas en Tizimín</span>**
```{r indicador_ovitrampas_tizimin, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Tizimín",
                            all = FALSE)

```

#### **<span style="color:#7d9029"> Manzanas Calientes de Tizimín en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_tizimin, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}


# Step 2. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")


# Step 2.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)

# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Tizimín",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "96",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```


#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Tizimín en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_tizimin, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Tizimín",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 80,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-2,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```

#### **<span style="color:#7d9029">Indicador de Ovitrampas en Piste</span>**
```{r indicador_ovitrampas_piste, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Pisté",
                            all = FALSE)

```

#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Piste en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_piste, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

```

#### **<span style="color:#7d9029">Indicador de Ovitrampas en Ticul</span>**
```{r indicador_ovitrampas_ticul, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Ticul",
                            all = FALSE)

```

#### **<span style="color:#7d9029"> Manzanas Calientes de Ticul en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_ticul, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}



# Step 2. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")

# Step 2.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)

# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Ticul",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "89",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```

#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Ticul en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_ticul, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Ticul",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 90,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-1,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```

#### **<span style="color:#7d9029">Indicador de Ovitrampas en Peto</span>**
```{r indicador_ovitrampas_peto, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Peto",
                            all = FALSE)

```

#### **<span style="color:#7d9029"> Manzanas Calientes de Peto en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_peto, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}



# Step 2. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")

# Step 2.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)

# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Peto",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "58",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```

#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Peto en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_peto, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Peto",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 80,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-1,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```

#### **<span style="color:#7d9029">Indicador de Ovitrampas en Tekax</span>**
```{r indicador_ovitrampas_tekax, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Tekax De Álvaro Obregón",
                            all = FALSE)

```

#### **<span style="color:#7d9029"> Manzanas Calientes de Tekax en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_tekax, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}



# Step 2. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")

# Step 2.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)

# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Tekax De Álvaro Obregón",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "79",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```

#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Tekax en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_tekax, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Tekax De Álvaro Obregón",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 80,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-1,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```

#### **<span style="color:#7d9029">Indicador de Ovitrampas en Oxkutzcab</span>**
```{r indicador_ovitrampas_oxkutzcab, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}

#  indicar ovitrampas
library(ggplot2)
boldenr::ovitraps_indicator(x = ovis,
                            nom_loc = "Oxkutzcab",
                            all = FALSE)

```

#### **<span style="color:#7d9029"> Manzanas Calientes de Oxkutzcab en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r manzanas_calientes_oxkutzcab, echo=FALSE, error=TRUE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}



# Step 2. load the blocks #####
#load("C:/Users/HOME/OneDrive/automatic_read_ine_2010/8.RData/block_ine10_mx.RData")

# Step 2.1 extract the block of yucatan state ###
#x <- rgeomex::blocks_ine20_mx_c
x <- blocks_ine10_mx |> dplyr::filter(ENTIDAD == 31)

# Step 2. hotblocks #####
boldenr::hot_blocks(loc = "Oxkutzcab",
                    x = ovis,
                    blocks = x,
                    cve_mpo = "56",
                    sem1 = lubridate::epiweek(Sys.time())-1,
                    risk = TRUE)



```

#### **<span style="color:#7d9029"> Predicción del Número de Huevos en el área urbana de Oxkutzcab en la semana `r lubridate::epiweek(Sys.Date())-1`</span>**
```{r eggs_prediction_oxkutzcab, echo=FALSE, error=FALSE, message=FALSE,dpi=300, warning=FALSE, fig.align = "center", out.width="90%", fig.show = "hold"}
deneggs::eggs_hotspots(path_lect = path_vect,
                       cve_ent = 31,
                       locality  = "Oxkutzcab",
                       path_coord = path_coord,
                       longitude  = "Pocision_X",
                       latitude =  "Pocision_Y",
                       aproximation = "gaussian",
                       integration = "eb",
                       fam = "zeroinflatednbinomial1",
                       k = 80,
                       palette_vir  = "magma",
                       leg_title = "Huevos",
                       plot = FALSE,
                       hist_dataset = FALSE, ##### NOTA
                       sem = lubridate::epiweek(Sys.Date())-1,
                       var = "eggs",
                       cell_size = 2000,
                       alpha = .99)$map

```

</div>
</body>
</html>


**Acciones de Control**
=====================================  

Column {.tabset}
------------------------------------

### **<span style="color:#660033"> Control Larvario </span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: white;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>

#### Avances de **Control Larvario** Por **Jurisdicción Sanitaria**
```{r cl_juri, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::cl_table(x = cl, jur = NULL, mun = FALSE)
``` 
 <hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

####  **<span style="color:#7d9029">Avances de Control Larvario por Municipio de la Jurisdición 01 Mérida</span>**
```{r cl_merida, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::cl_table(x = cl, jur = "Mérida", mun = TRUE)
``` 

<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

#### **<span style="color:#7d9029">Avances de Control Larvario en el área urbana de Mérida</span>**
```{r cl_merida_map, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
merida_acumulado <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Acumulado")
merida_dos <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Últimos Dos Meses")
merida_uno <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Último Mes")
merida_sem <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Última Semana")
leafsync::sync(merida_acumulado, 
               merida_dos,
               merida_uno,
               merida_sem)

``` 

<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">


####  **<span style="color:#7d9029">Avances de Control Larvario por Municipio de la Jurisdición 02 Valladolid</span>**
```{r cl_valladolid, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::cl_table(x = cl, jur = "Valladolid", mun = TRUE)
``` 

<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

####  **<span style="color:#7d9029">Avances de Control Larvario por Municipio de la Jurisdición 03 Ticul</span>**
```{r cl_ticul, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::cl_table(x = cl, jur = "Ticul", mun = TRUE)
``` 

</div>
</body>
</html>

#### **<span style="color:#660033">Control Larvario en Mérida</span>**
```{r cl_map_merida, echo = FALSE, error = TRUE,  message=FALSE, dpi=300, warning = FALSE}
acumulado <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Acumulado")
dos <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Últimos Dos Meses")
uno <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Último Mes")
sem <- cl_interactive_map(cl_dataset = control_larvario_blocks,
                                       cve_edo = "31",
                                       locality = "Mérida",
                                       time = "Última Semana")
leafsync::sync(acumulado, 
               dos,
               uno,
               sem)

``` 



### **<span style="color:#660033"> Nebulización en Frío (ULV)</span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: white;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>
  
####  **<span style="color:#7d9029">Avances de Nebulizacion en Frío (UBV) por Jurisdición Sanitaria</span>**
```{r ulv_yucatan, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = NULL, mun = FALSE, coldfog = TRUE)
```  
 
####  **<span style="color:#7d9029">Avances de Nebulizacion en Frío (UBV)por Municipio de la Jurisdición 01 Mérida</span>**
```{r ulv_merida, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = "Mérida", mun = TRUE, coldfog = TRUE)
``` 

####  **<span style="color:#7d9029">Avances de Nebulizacion en Frío (UBV) por Municipio de la Jurisdición 02 Valladolid</span>**
```{r ulv_valladolid, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = "Valladolid", mun = TRUE, coldfog = TRUE)
``` 

####  **<span style="color:#7d9029">Avances de Nebulizacion en Frío (UBV) por Municipio de la Jurisdición 03 Ticul</span>**
```{r ulv_ticul, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = "Ticul", mun = TRUE, coldfog = TRUE)
``` 

</div>
</body>
</html> 


### **<span style="color:#660033">Termonebulización</span>**
<html>
<head>
<style>
.myDiv1 {
  border: 2px outset darkgreen;
  background-color: white;
  text-align: center;
}
</style>
</head>
<body>

<div class="myDiv1">
  <h2></h2>
  <p></p>
  
####  **<span style="color:#7d9029">Termonubulización por Jurisdición Sanitaria</span>**
```{r termo_yucatan, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = NULL, mun = FALSE, coldfog = FALSE)
```  
 <hr style="height:2px;border-width:0;color:#330019;background-color:#330019">
 
####  **<span style="color:#7d9029">Termonebulización Municipio de la Jurisdición 01 Mérida</span>**
```{r termo_merida, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = "Mérida", mun = TRUE, coldfog = FALSE)
``` 
<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

####  **<span style="color:#7d9029">Termonebulización por Municipio de la Jurisdición 02 Valladolid</span>**
```{r termo_valladolid, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = "Valladolid", mun = TRUE, coldfog = FALSE)
``` 

<hr style="height:2px;border-width:0;color:#330019;background-color:#330019">

####  **<span style="color:#7d9029">Termonebulización por Municipio de la Jurisdición 03 Ticul</span>**
```{r termo_ticul, echo = FALSE, error = TRUE, cache = TRUE,  fig.align = "center", message=FALSE, dpi=300, warning = FALSE,fig.show = "hold"}
boldenr::tb_ulv(x = neb, jur = "Ticul", mun = TRUE, coldfog = FALSE)
``` 

</div>
</body>
</html> 


# **Hotspots de la Transmisión de Dengue**

Column {.tabset}
------------------------------------


### **<span style="color:#990000">Mérida</span>**
<html>
<head>
<style>
body {
  margin: 0px;
}

.wrapper {
    display: grid;
    grid-gap: 2px;
    grid-template-columns: 280px 280px 280px 550px;
    grid-template-rows: 165px 165px 165px 165px;
    background-color: #fff;
    color: "green";
  }

  .box {
    background-color: #cfcfc4;
    color: "green";
    border-radius: 2px;
    padding: 5px;
    font-size: 100%;

  }

  .a {
    grid-column: 1 / 4;
    grid-row: 1 / 4;
  }
  .b {
    grid-column: 4 ;
    grid-row: 1 / 3;
  }
  .c {
    grid-column: 4 ;
    grid-row: 3 / 5 ;
  }
  .d {
    grid-column: 3;
    grid-row: 4;
  }
  .e {
    grid-column: 2;
    grid-row: 4;
  }
  .f {
    grid-column: 1;
    grid-row: 4;
  }
</style>
</head>
<body>
<div class="wrapper">
  <div class="box a">
```{r hotspots_dengue_merida}
hotspots_map(cve_ent = "31",
             locality = "Mérida",
             hotspots = cases_hotspots_agebs19,
             static_map = FALSE)

```
  </div>
  <div class="box b">
```{r forest_plot_merida, dpi = 300, fig.height= 5,fig.width = 7,fig.align = "center", out.height='100%', out.width = '100%',fig.show = "hold"}
 
# extract the locality
loc <- extract_locality(cve_edo = "31",
                        locality = "Mérida")

hotspots <- cases_hotspots_agebs19[loc,]
# Logistic Regression
glm.fit <- glm(hotspots_gi ~ DENV_2008 + DENV_2009 +  DENV_2010 + DENV_2011 + 
                   DENV_2012 + DENV_2013  +  DENV_2014 + 
                   DENV_2015  +  DENV_2016  +  DENV_2019 +
                   DENV_2020 + DENV_2021,
               data = hotspots, 
               family = binomial)

result <- parameters::model_parameters(glm.fit, 
                                      exponentiate = TRUE)

plotly::ggplotly(plot(result, size_text = 1))
```
  </div>
  <div class="box c">
```{r power_law_plot_merida,dpi = 300, warning=FALSE, fig.align = "center", out.width = '100%',out.height='100%',fig.show = "hold"}
# Step 7. make the function por calculate the cumulative ####
funcumsum <- function(x){
    x$cumulative_n <- cumsum(x$n_cases)
    x$perc_cumsum_n <- round((cumsum(x$n_cases)/sum(x$n_cases))*100, digits = 1)
    #x$cumulative_ha <- cumsum(x$ha)
    #x$perc_cumsum_ha <- round((cumsum(x$ha)/sum(x$ha))*100, digits = 1)
    x$id <- 1
    x$id_cumsum <- cumsum(x$id)
    x$id_perc_cum <- round((cumsum(x$id)/nrow(x))*100, digits = 1)
    x
}
# step 8.

data_pareto <- hotspots   %>% 
    sf::st_drop_geometry()  %>% 
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality")  %>% 
    dplyr::select(loc, n_cases, hotspots_gi)  %>% 
    dplyr::arrange(loc, desc(hotspots_gi), desc(n_cases))  %>% 
    dplyr::group_by(loc)  %>% 
    tidyr::nest()  %>% 
    dplyr::mutate(pareto_cases = purrr::map(data,
                                            funcumsum))  %>% 
    dplyr::select(-data)  %>% 
    tidyr::unnest(cols = c(pareto_cases))

# step 4. visualization of pareto rules 
plotly::ggplotly(denhotspots::power_law_plot(x = data_pareto))  %>%  plotly::layout(showlegend = FALSE)

```
  </div>
  <div class="box d">
```{r gauge_blocks_merida,fig.align = "center", out.height='100%', out.width = '100%', fig.width= 1.5, fig.height=1}
y_hot <- hotspots %>% dplyr::filter(hotspots_gi == 1)
centroid <- rgeomex::blocks_ine20_mx_centroid %>%
  sf::st_as_sf(coords = c("x", "y"), crs = 4326)
b_loc <- centroid[hotspots, ]
b_hot <- b_loc[y_hot, ]
flexdashboard::gauge(round((nrow(b_hot)/nrow(b_loc))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Manzanas",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
  <div class="box e">
```{r gauge_AGEB_merida, fig.align = "center", out.height='100%', out.width = '100%'}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)
  
flexdashboard::gauge(round((nrow(y_hot)/nrow(y))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "AGEBs",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
<div class="box f">
```{r gauge_casos_merida, out.height='90%', out.width = '90%', fig.align = "center"}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)

flexdashboard::gauge(round((sum(y_hot$n_cases)/sum(y$n_cases))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Casos de Dengue",
      flexdashboard::gaugeSectors(success = c(11, 100), 
                   warning = c(6, 10), 
                   danger = c(0, 5),
                   colors = c("success", "warning","danger"))
      )
```
 </div>
</div>
</body>
</html>


### **<span style="color:#990000">Valladolid</span>**

<html>
<head>
<style>
body {
  margin: 0px;
}

.wrapper {
    display: grid;
    grid-gap: 2px;
    grid-template-columns: 280px 280px 280px 550px;
    grid-template-rows: 165px 165px 165px 165px;
    background-color: #fff;
    color: "green";
  }

  .box {
    background-color: #cfcfc4;
    color: "green";
    border-radius: 2px;
    padding: 5px;
    font-size: 100%;

  }

  .a {
    grid-column: 1 / 4;
    grid-row: 1 / 4;
  }
  .b {
    grid-column: 4 ;
    grid-row: 1 / 3;
  }
  .c {
    grid-column: 4 ;
    grid-row: 3 / 5 ;
  }
  .d {
    grid-column: 3;
    grid-row: 4;
  }
  .e {
    grid-column: 2;
    grid-row: 4;
  }
  .f {
    grid-column: 1;
    grid-row: 4;
  }
</style>
</head>
<body>
<div class="wrapper">
  <div class="box a">
```{r hotspots_dengue_valladolid}
hotspots_map(cve_ent = "31",
             locality = "Valladolid",
             hotspots = cases_hotspots_agebs19,
             static_map = FALSE)

```
  </div>
  <div class="box b">
```{r forest_plot_valladolid, dpi = 300, fig.height= 5,fig.width = 7,fig.align = "center", out.height='100%', out.width = '100%',fig.show = "hold"}
 
# extract the locality
loc <- extract_locality(cve_edo = "31",
                        locality = "Valladolid")

hotspots <- cases_hotspots_agebs19[loc,]
# Logistic Regression
glm.fit <- glm(hotspots_gi ~ DENV_2008 + DENV_2009 +  DENV_2010  + 
                   DENV_2012 + DENV_2013  +  DENV_2014 + 
                   DENV_2015  + DENV_2018+ DENV_2019 +
                   DENV_2020,
               data = hotspots, 
               family = binomial)

result <- parameters::model_parameters(glm.fit, 
                                      exponentiate = TRUE)

plotly::ggplotly(plot(result, size_text = 1))
```
  </div>
  <div class="box c">
```{r power_law_plot_valladolid,dpi = 300, warning=FALSE, fig.align = "center", out.width = '100%',out.height='100%',fig.show = "hold"}
# Step 7. make the function por calculate the cumulative ####
funcumsum <- function(x){
    x$cumulative_n <- cumsum(x$n_cases)
    x$perc_cumsum_n <- round((cumsum(x$n_cases)/sum(x$n_cases))*100, digits = 1)
    #x$cumulative_ha <- cumsum(x$ha)
    #x$perc_cumsum_ha <- round((cumsum(x$ha)/sum(x$ha))*100, digits = 1)
    x$id <- 1
    x$id_cumsum <- cumsum(x$id)
    x$id_perc_cum <- round((cumsum(x$id)/nrow(x))*100, digits = 1)
    x
}
# step 8.

data_pareto <- hotspots   %>% 
    sf::st_drop_geometry()  %>% 
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality")  %>% 
    dplyr::select(loc, n_cases, hotspots_gi)  %>% 
    dplyr::arrange(loc, desc(hotspots_gi), desc(n_cases))  %>% 
    dplyr::group_by(loc)  %>% 
    tidyr::nest()  %>% 
    dplyr::mutate(pareto_cases = purrr::map(data,
                                            funcumsum))  %>% 
    dplyr::select(-data)  %>% 
    tidyr::unnest(cols = c(pareto_cases))

# step 4. visualization of pareto rules 
plotly::ggplotly(denhotspots::power_law_plot(x = data_pareto))  %>%  plotly::layout(showlegend = FALSE)

```
  </div>
  <div class="box d">
```{r gauge_blocks_valladolid,fig.align = "center", out.height='100%', out.width = '100%', fig.width= 1.5, fig.height=1}
y_hot <- hotspots %>% dplyr::filter(hotspots_gi == 1)
centroid <- rgeomex::blocks_ine20_mx_centroid %>%
  sf::st_as_sf(coords = c("x", "y"), crs = 4326)
b_loc <- centroid[hotspots, ]
b_hot <- b_loc[y_hot, ]
flexdashboard::gauge(round((nrow(b_hot)/nrow(b_loc))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Manzanas",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
  <div class="box e">
```{r gauge_AGEB_valladolid, fig.align = "center", out.height='100%', out.width = '100%'}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)
  
flexdashboard::gauge(round((nrow(y_hot)/nrow(y))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "AGEBs",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
<div class="box f">
```{r gauge_casos_valladolid, out.height='90%', out.width = '90%', fig.align = "center"}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)

flexdashboard::gauge(round((sum(y_hot$n_cases)/sum(y$n_cases))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Casos de Dengue",
      flexdashboard::gaugeSectors(success = c(11, 100), 
                   warning = c(6, 10), 
                   danger = c(0, 5),
                   colors = c("success", "warning","danger"))
      )
```
</div>
</div>
</body>
</html>

### **<span style="color:#990000">Tizimín</span>**

<html>
<head>
<style>
body {
  margin: 0px;
}

.wrapper {
    display: grid;
    grid-gap: 2px;
    grid-template-columns: 280px 280px 280px 550px;
    grid-template-rows: 165px 165px 165px 165px;
    background-color: #fff;
    color: "green";
  }

  .box {
    background-color: #cfcfc4;
    color: "green";
    border-radius: 2px;
    padding: 5px;
    font-size: 100%;

  }

  .a {
    grid-column: 1 / 4;
    grid-row: 1 / 4;
  }
  .b {
    grid-column: 4 ;
    grid-row: 1 / 3;
  }
  .c {
    grid-column: 4 ;
    grid-row: 3 / 5 ;
  }
  .d {
    grid-column: 3;
    grid-row: 4;
  }
  .e {
    grid-column: 2;
    grid-row: 4;
  }
  .f {
    grid-column: 1;
    grid-row: 4;
  }
</style>
</head>
<body>
<div class="wrapper">
  <div class="box a">
```{r hotspots_dengue_tizimin}
hotspots_map(cve_ent = "31",
             locality = "Tizimín",
             hotspots = cases_hotspots_agebs19,
             static_map = FALSE)

```
  </div>
  <div class="box b">
```{r forest_plot_tizimin, dpi = 300, fig.height= 5,fig.width = 7,fig.align = "center", out.height='100%', out.width = '100%',fig.show = "hold"}
 
# extract the locality
loc <- extract_locality(cve_edo = "31",
                        locality = "Tizimín")

hotspots <- cases_hotspots_agebs19[loc,]
# Logistic Regression
glm.fit <- glm(hotspots_gi ~  DENV_2009 +  DENV_2010 + DENV_2011 + 
                   DENV_2012 + DENV_2013  +  
                   DENV_2015  +  DENV_2016  + DENV_2018 + DENV_2019,
               data = hotspots, 
               family = binomial)

result <- parameters::model_parameters(glm.fit, 
                                      exponentiate = TRUE)

plotly::ggplotly(plot(result, size_text = 1))
```
  </div>
  <div class="box c">
```{r power_law_plot_tizimin,dpi = 300, warning=FALSE, fig.align = "center", out.width = '100%',out.height='100%',fig.show = "hold"}
# Step 7. make the function por calculate the cumulative ####
funcumsum <- function(x){
    x$cumulative_n <- cumsum(x$n_cases)
    x$perc_cumsum_n <- round((cumsum(x$n_cases)/sum(x$n_cases))*100, digits = 1)
    #x$cumulative_ha <- cumsum(x$ha)
    #x$perc_cumsum_ha <- round((cumsum(x$ha)/sum(x$ha))*100, digits = 1)
    x$id <- 1
    x$id_cumsum <- cumsum(x$id)
    x$id_perc_cum <- round((cumsum(x$id)/nrow(x))*100, digits = 1)
    x
}
# step 8.

data_pareto <- hotspots   %>% 
    sf::st_drop_geometry()  %>% 
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality")  %>% 
    dplyr::select(loc, n_cases, hotspots_gi)  %>% 
    dplyr::arrange(loc, desc(hotspots_gi), desc(n_cases))  %>% 
    dplyr::group_by(loc)  %>% 
    tidyr::nest()  %>% 
    dplyr::mutate(pareto_cases = purrr::map(data,
                                            funcumsum))  %>% 
    dplyr::select(-data)  %>% 
    tidyr::unnest(cols = c(pareto_cases))

# step 4. visualization of pareto rules 
plotly::ggplotly(denhotspots::power_law_plot(x = data_pareto))  %>%  plotly::layout(showlegend = FALSE)

```
  </div>
  <div class="box d">
```{r gauge_blocks_tizimin,fig.align = "center", out.height='100%', out.width = '100%', fig.width= 1.5, fig.height=1}
y_hot <- hotspots %>% dplyr::filter(hotspots_gi == 1)
centroid <- rgeomex::blocks_ine20_mx_centroid %>%
  sf::st_as_sf(coords = c("x", "y"), crs = 4326)
b_loc <- centroid[hotspots, ]
b_hot <- b_loc[y_hot, ]
flexdashboard::gauge(round((nrow(b_hot)/nrow(b_loc))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Manzanas",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
  <div class="box e">
```{r gauge_AGEB_tizimin, fig.align = "center", out.height='100%', out.width = '100%'}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)
  
flexdashboard::gauge(round((nrow(y_hot)/nrow(y))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "AGEBs",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
<div class="box f">
```{r gauge_casos_tizimin, out.height='90%', out.width = '90%', fig.align = "center"}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)

flexdashboard::gauge(round((sum(y_hot$n_cases)/sum(y$n_cases))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Casos de Dengue",
      flexdashboard::gaugeSectors(success = c(11, 100), 
                   warning = c(6, 10), 
                   danger = c(0, 5),
                   colors = c("success", "warning","danger"))
      )
```
</div>
</div>
</body>
</html>


### **<span style="color:#990000">Ticul</span>**

<html>
<head>
<style>
body {
  margin: 0px;
}

.wrapper {
    display: grid;
    grid-gap: 2px;
    grid-template-columns: 280px 280px 280px 550px;
    grid-template-rows: 165px 165px 165px 165px;
    background-color: #fff;
    color: "green";
  }

  .box {
    background-color: #cfcfc4;
    color: "green";
    border-radius: 2px;
    padding: 5px;
    font-size: 100%;

  }

  .a {
    grid-column: 1 / 4;
    grid-row: 1 / 4;
  }
  .b {
    grid-column: 4 ;
    grid-row: 1 / 3;
  }
  .c {
    grid-column: 4 ;
    grid-row: 3 / 5 ;
  }
  .d {
    grid-column: 3;
    grid-row: 4;
  }
  .e {
    grid-column: 2;
    grid-row: 4;
  }
  .f {
    grid-column: 1;
    grid-row: 4;
  }
</style>
</head>
<body>
<div class="wrapper">
  <div class="box a">
```{r hotspots_dengue_ticul}
hotspots_map(cve_ent = "31",
             locality = "Ticul",
             hotspots = cases_hotspots_agebs19,
             static_map = FALSE)

```
  </div>
  <div class="box b">
```{r forest_plot_ticul, dpi = 300, fig.height= 5,fig.width = 7,fig.align = "center", out.height='100%', out.width = '100%',fig.show = "hold"}
 
# extract the locality
loc <- extract_locality(cve_edo = "31",
                        locality = "Ticul")

hotspots <- cases_hotspots_agebs19[loc,]
# Logistic Regression
glm.fit <- glm(hotspots_gi ~  DENV_2009 +  DENV_2010 + DENV_2011 + 
                   DENV_2012 + DENV_2013  +  DENV_2014 +
                   DENV_2016  + DENV_2018 + DENV_2019 + DENV_2020,
               data = hotspots, 
               family = binomial)

result <- parameters::model_parameters(glm.fit, 
                                      exponentiate = TRUE)

plotly::ggplotly(plot(result, size_text = 1))
```
  </div>
  <div class="box c">
```{r power_law_plot_ticul,dpi = 300, warning=FALSE, fig.align = "center", out.width = '100%',out.height='100%',fig.show = "hold"}
# Step 7. make the function por calculate the cumulative ####
funcumsum <- function(x){
    x$cumulative_n <- cumsum(x$n_cases)
    x$perc_cumsum_n <- round((cumsum(x$n_cases)/sum(x$n_cases))*100, digits = 1)
    #x$cumulative_ha <- cumsum(x$ha)
    #x$perc_cumsum_ha <- round((cumsum(x$ha)/sum(x$ha))*100, digits = 1)
    x$id <- 1
    x$id_cumsum <- cumsum(x$id)
    x$id_perc_cum <- round((cumsum(x$id)/nrow(x))*100, digits = 1)
    x
}
# step 8.

data_pareto <- hotspots   %>% 
    sf::st_drop_geometry()  %>% 
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality")  %>% 
    dplyr::select(loc, n_cases, hotspots_gi)  %>% 
    dplyr::arrange(loc, desc(hotspots_gi), desc(n_cases))  %>% 
    dplyr::group_by(loc)  %>% 
    tidyr::nest()  %>% 
    dplyr::mutate(pareto_cases = purrr::map(data,
                                            funcumsum))  %>% 
    dplyr::select(-data)  %>% 
    tidyr::unnest(cols = c(pareto_cases))

# step 4. visualization of pareto rules 
plotly::ggplotly(denhotspots::power_law_plot(x = data_pareto))  %>%  plotly::layout(showlegend = FALSE)

```
  </div>
  <div class="box d">
```{r gauge_blocks_ticul,fig.align = "center", out.height='100%', out.width = '100%', fig.width= 1.5, fig.height=1}
y_hot <- hotspots %>% dplyr::filter(hotspots_gi == 1)
centroid <- rgeomex::blocks_ine20_mx_centroid %>%
  sf::st_as_sf(coords = c("x", "y"), crs = 4326)
b_loc <- centroid[hotspots, ]
b_hot <- b_loc[y_hot, ]
flexdashboard::gauge(round((nrow(b_hot)/nrow(b_loc))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Manzanas",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
  <div class="box e">
```{r gauge_AGEB_ticul, fig.align = "center", out.height='100%', out.width = '100%'}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)
  
flexdashboard::gauge(round((nrow(y_hot)/nrow(y))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "AGEBs",
      flexdashboard::gaugeSectors(success = c(0, 30), 
                                  warning = c(31, 50), 
                                  danger = c(51, 100),
                                  colors = c("success", "warning","danger")))
```
  </div>
<div class="box f">
```{r gauge_casos_ticul, out.height='90%', out.width = '90%', fig.align = "center"}

y <- hotspots  %>%
    sf::st_drop_geometry() %>%
    dplyr::mutate(n_cases = rowSums(dplyr::select(., dplyr::starts_with("DENV"))),
                  loc = "locality") %>%
    dplyr::select(loc, n_cases, hotspots_gi) 
y_hot <- y %>% dplyr::filter(hotspots_gi == 1)

flexdashboard::gauge(round((sum(y_hot$n_cases)/sum(y$n_cases))*100, digits = 1),
      min = 0, max = 100, 
      symbol = '%', 
      label = "Casos de Dengue",
      flexdashboard::gaugeSectors(success = c(11, 100), 
                   warning = c(6, 10), 
                   danger = c(0, 5),
                   colors = c("success", "warning","danger"))
      )
```
</div>
</div>
</body>
</html>


# **Hotspots del Vector del Dengue**

Column {.tabset}
------------------------------------


### **<span style="color:#990000">Mérida</span>**
```{r vector_hotspots_merida}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Mérida")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                                      fill = NA, 
                                      alpha = 1, 
                                      col = "darkgreen", 
                                      lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```


### **<span style="color:#990000">Hunucma</span>**

```{r vector_hotspots_Hunucma}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Hunucma")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     #ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                     #                 fill = NA, 
                     #                 alpha = 1, 
                     #                 col = "darkgreen", 
                     #                lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```


### **<span style="color:#990000">Progreso</span>**
```{r vector_hotspots_progreso}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Progreso")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     #ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                      #                fill = NA, 
                      #                alpha = 1, 
                       #               col = "darkgreen", 
                       #               lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```

### **<span style="color:#990000">Motul</span>**

```{r vector_hotspots_motul}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Motul de Carrillo Puerto")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     #ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                     #                 fill = NA, 
                      #                alpha = 1, 
                       #               col = "darkgreen", 
                      #                lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```


### **<span style="color:#990000">Valladolid</span>**

```{r vector_hotspots_valladolid}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Valladolid")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                                      fill = NA, 
                                      alpha = 1, 
                                      col = "darkgreen", 
                                      lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```

### **<span style="color:#990000">Tizimin</span>**

```{r vector_hotspots_tizimin}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Tizimin")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                                      fill = NA, 
                                      alpha = 1, 
                                      col = "darkgreen", 
                                      lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```

### **<span style="color:#990000">Ticul</span>**

```{r vector_hotspots_ticul}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Ticul")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                                      fill = NA, 
                                      alpha = 1, 
                                      col = "darkgreen", 
                                      lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```

### **<span style="color:#990000">Tekax</span>**
```{r vector_hotspots_tekax}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Tekax de Alvaro Obregón")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5)  +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```

### **<span style="color:#990000">Peto</span>**
```{r vector_hotspots_peto}
# Step 1. extract the locality 
locality <- extract_locality(cve_edo = "31", locality = "Peto")

# Step 2. extract the hotspots of locality
hotspots <- cases_hotspots_agebs19[locality, ]

# step 2. extract the eggs hotspots of locality ####

# Step 2.1 convert the df to sf object 
x <- betas_31_yucatan |>
    dplyr::mutate(long = x,
                  lat = y) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326)

# Step 2.2 extract the eggs hotspots of locality
x <- x[locality, ] 

# Step 3. calculate the intensity 
x <- x |>
    sf::st_drop_geometry() |>
    dplyr::group_by(year) |>
    tidyr::nest() |>
    dplyr::mutate(intensity = purrr::map(data,intensity_function)) |>
    dplyr::select(-data) |>
    tidyr::unnest(cols = c(intensity))


# step 4 plot the map ####
plotly::ggplotly(ggplot2::ggplot() +
                     ggplot2::geom_tile(data = x,
                                        ggplot2::aes(x = x,
                                                     y = y,
                                                     fill = intensity)) +
                     #ggplot2::scale_fill_distiller(palette = input$variablespalette, direction = 1) +
                     ggplot2::scale_fill_distiller(palette = "Blues", direction = 1) +
                     ggplot2::geom_sf(data = locality,  
                                      alpha = 1, 
                                      fill = NA,
                                      col = "black", 
                                      lwd = 0.5) +
                     #ggplot2::geom_sf(data = hotspots |> dplyr::filter(intensity_gi > 0), 
                      #                fill = NA, 
                       #               alpha = 1, 
                        #              col = "darkgreen", 
                           #           lwd = 0.1) +
                     ggplot2::facet_wrap(facets = "year") +
                     ggplot2::theme_void() +
                     ggplot2::theme(legend.position = "bottom") +
                     ggplot2::theme(legend.key.size = ggplot2::unit(.8, "cm"),
                                    legend.key.width = ggplot2::unit(.5,"cm"),
                                    legend.margin= ggplot2::margin(0,0,0,0),
                                    legend.box.margin= ggplot2::margin(-20,0,0,0)) +
                     ggplot2::theme(legend.text = ggplot2::element_text(colour = "black",
                                                                        face  = "bold"),
                                    legend.title = ggplot2::element_text(colour = "darkred",
                                                                         face  = "bold")) +
                     ggplot2::theme(strip.text = ggplot2::element_text(size = 11,
                                                                       face = "bold"))) |>
    plotly::layout(legend = list(orientation = 'h'))

```



**Dengue Risk Maps**
=====================================  

Column {.tabset}
-------------------------------------

### **<span style="color:#7d9029">Mérida</span>**

```{r, risk_map_merida, echo=FALSE}
risk <- risk_agebs(spde_model = betas_31_yucatan,
                          hotspots = cases_hotspots_agebs19,
                          locality = "Mérida",
                          cve_ent = "31",
                          intensity_perc = 25)
risk_map(risk = risk, staticmap = FALSE)
```


### **<span style="color:#7d9029">Valladolid</span>**

```{r, risk_map_valladolid, echo=FALSE}
risk <- risk_agebs(spde_model = betas_31_yucatan,
                          hotspots = cases_hotspots_agebs19,
                          locality = "Valladolid",
                          cve_ent = "31",
                          intensity_perc = 25)
risk_map(risk = risk, staticmap = FALSE)
```


### **<span style="color:#7d9029">Tizimín</span>**

```{r, risk_map_tizimin, echo=FALSE}
risk <- risk_agebs(spde_model = betas_31_yucatan,
                          hotspots = cases_hotspots_agebs19,
                          locality = "Tizimín",
                          cve_ent = "31",
                          intensity_perc = 25)
risk_map(risk = risk, staticmap = FALSE)
```

### **<span style="color:#7d9029">Ticul</span>**

```{r, risk_map_ticul, echo=FALSE}
risk <- risk_agebs(spde_model = betas_31_yucatan,
                          hotspots = cases_hotspots_agebs19,
                          locality = "Ticul",
                          cve_ent = "31",
                          intensity_perc = 25)
risk_map(risk = risk, staticmap = FALSE)
```



**Cadenas de Transmisión**
=====================================  

Column {.tabset}
-------------------------------------


### **<span style="color:#7d9029">Merida</span>**

```{r cadenas_merida}

#load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/denv_31_yucatan.RData")
 load("C:/Users/HOME/OneDrive/proyects/geocoding_mex/2022/9.RData_geocoded/den2022_positivos.RData")

# Step 2. create the column onset and conver to sf object ####
z$onset <- z$FEC_INI_SIGNOS_SINT
z <- z |>
    dplyr::mutate(x = long,
                  y = lat) |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326) |>
    sf::st_make_valid()

# Step 3. Extract the high risk localities of Yucatán ####
loc <- extract_locality(cve_edo = "31",
                         locality = c("Mérida"))

# Step 4. Extract the dengue cases of  high risk localities #####
z <- z[loc, ] |>
    dplyr::select(onset, VEC_ID, x, y, IDE_EDA_ANO) |>
    sf::st_drop_geometry()


# Step 5. aplicar la prueba de knox
library(magrittr)
knox_res <- denhotspots::knox(x = z, 
                              crs = "+proj=eqc", 
                              ds = 400, # distance in meters
                              dt = 20,  # days 0 to 20 day
                              sym = 1000, 
                              sp_link = FALSE, # for sf
                              planar_coord = FALSE)

library(leaflet)
library(sf)
denhotspots::space_time_link_map(x = knox_res,
                                 locality = "Mérida",
                                 cve_edo = "31",
                                 maptype = "interactive_map",
                                 facetmap = FALSE)
```
